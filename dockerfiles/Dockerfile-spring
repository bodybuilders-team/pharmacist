ARG DEPENDENCY=./src/backend
ARG APP_HOME=/usr/app

FROM gradle:jdk21 AS CACHE_IMAGE
ARG DEPENDENCY
ARG APP_HOME
ENV GRADLE_USER_HOME=$APP_HOME/.gradle

RUN mkdir -p $APP_HOME
COPY $DEPENDENCY/build.gradle.kts $APP_HOME
WORKDIR $APP_HOME
RUN gradle --no-daemon

FROM gradle:jdk21 AS BUILDER_IMAGE
ARG DEPENDENCY
ARG APP_HOME
ENV GRADLE_USER_HOME=$APP_HOME/.gradle
COPY --from=CACHE_IMAGE $APP_HOME/.gradle $APP_HOME/.gradle

COPY $DEPENDENCY/settings.gradle.kts $APP_HOME
COPY $DEPENDENCY/build.gradle.kts $APP_HOME
COPY $DEPENDENCY/src $APP_HOME/src

WORKDIR $APP_HOME

RUN gradle bootJar --no-daemon

FROM amazoncorretto:21
ENV ARTIFACT_NAME=pharmacist-0.0.1-SNAPSHOT.jar
ARG APP_HOME

WORKDIR $APP_HOME
COPY --from=BUILDER_IMAGE $APP_HOME/build/libs/$ARTIFACT_NAME .

EXPOSE 8080
ENTRYPOINT exec java -jar ${ARTIFACT_NAME}